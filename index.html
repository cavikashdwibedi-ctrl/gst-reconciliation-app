<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SlideForge — Video Creator</title>
    <link href="https://fonts.googleapis.com/css2?family=Instrument+Sans:wght@400;500;600;700&family=DM+Serif+Display&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a0b;
            --bg-secondary: #141416;
            --bg-tertiary: #1c1c1f;
            --bg-hover: #252528;
            --accent: #6366f1;
            --accent-glow: rgba(99, 102, 241, 0.3);
            --accent-hover: #818cf8;
            --text-primary: #f4f4f5;
            --text-secondary: #a1a1aa;
            --text-muted: #71717a;
            --border: #27272a;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --radius: 12px;
            --radius-sm: 8px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Instrument Sans', -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image:
                linear-gradient(rgba(99, 102, 241, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(99, 102, 241, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            pointer-events: none;
            z-index: 0;
        }

        .app-container {
            position: relative;
            z-index: 1;
            max-width: 1600px;
            margin: 0 auto;
            padding: 24px;
            min-height: 100vh;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
            padding-bottom: 24px;
            border-bottom: 1px solid var(--border);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, var(--accent), #a855f7);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .logo-text {
            font-family: 'DM Serif Display', serif;
            font-size: 28px;
            letter-spacing: -0.5px;
        }

        .logo-text span {
            color: var(--accent);
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            border-radius: var(--radius-sm);
            font-family: inherit;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
            box-shadow: 0 0 20px var(--accent-glow);
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--accent-hover);
            transform: translateY(-1px);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-hover);
            border-color: var(--text-muted);
        }

        .main-content {
            display: grid;
            grid-template-columns: 320px 1fr 300px;
            gap: 24px;
            height: calc(100vh - 140px);
        }

        .panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-title {
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
        }

        .panel-body {
            padding: 16px;
            flex: 1;
            overflow-y: auto;
        }

        .slides-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .slide-card {
            background: var(--bg-tertiary);
            border: 2px solid transparent;
            border-radius: var(--radius-sm);
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .slide-card:hover {
            border-color: var(--border);
        }

        .slide-card.active {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        .slide-card-preview {
            aspect-ratio: 16/9;
            background: var(--bg-primary);
            border-radius: 6px;
            margin-bottom: 10px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .slide-card-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .slide-card-preview .placeholder {
            color: var(--text-muted);
            font-size: 12px;
        }

        .slide-card-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .slide-card-number {
            font-size: 13px;
            font-weight: 500;
        }

        .slide-card-duration {
            font-size: 12px;
            color: var(--text-muted);
        }

        .slide-card-delete {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            background: rgba(239, 68, 68, 0.9);
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .slide-card:hover .slide-card-delete {
            opacity: 1;
        }

        .add-slide-btn {
            width: 100%;
            padding: 24px;
            background: var(--bg-tertiary);
            border: 2px dashed var(--border);
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            font-family: inherit;
            font-size: 14px;
        }

        .add-slide-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: rgba(99, 102, 241, 0.05);
        }

        .add-slide-btn svg {
            width: 32px;
            height: 32px;
        }

        .preview-panel {
            display: flex;
            flex-direction: column;
        }

        .preview-stage {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px;
            background: var(--bg-primary);
            position: relative;
        }

        .preview-canvas-wrapper {
            position: relative;
            width: 100%;
            max-width: 800px;
            aspect-ratio: 16/9;
            background: #000;
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        #previewCanvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .preview-controls {
            padding: 16px 24px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .play-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--accent);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            box-shadow: 0 0 20px var(--accent-glow);
        }

        .play-btn:hover {
            transform: scale(1.05);
            background: var(--accent-hover);
        }

        .play-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .play-btn svg {
            width: 20px;
            height: 20px;
        }

        .timeline {
            flex: 1;
            height: 6px;
            background: var(--bg-tertiary);
            border-radius: 3px;
            position: relative;
            cursor: pointer;
        }

        .timeline-progress {
            height: 100%;
            background: var(--accent);
            border-radius: 3px;
            width: 0%;
            transition: width 0.1s linear;
        }

        .time-display {
            font-size: 13px;
            color: var(--text-secondary);
            font-variant-numeric: tabular-nums;
            min-width: 100px;
            text-align: right;
        }

        .settings-group {
            margin-bottom: 24px;
        }

        .settings-group-title {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 12px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            padding: 10px 14px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        .form-input::placeholder {
            color: var(--text-muted);
        }

        textarea.form-input {
            min-height: 80px;
            resize: vertical;
        }

        .form-select {
            width: 100%;
            padding: 10px 14px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 14px;
            cursor: pointer;
        }

        .form-select:focus {
            outline: none;
            border-color: var(--accent);
        }

        .range-input {
            width: 100%;
            -webkit-appearance: none;
            height: 6px;
            background: var(--bg-tertiary);
            border-radius: 3px;
            outline: none;
        }

        .range-input::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px var(--accent-glow);
        }

        .range-value {
            text-align: right;
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .color-picker-wrapper {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .color-picker {
            width: 40px;
            height: 40px;
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            cursor: pointer;
            padding: 0;
            overflow: hidden;
        }

        .color-picker::-webkit-color-swatch-wrapper {
            padding: 0;
        }

        .color-picker::-webkit-color-swatch {
            border: none;
            border-radius: 4px;
        }

        .color-presets {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .color-preset {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .color-preset:hover {
            transform: scale(1.1);
        }

        .color-preset.active {
            border-color: white;
        }

        .upload-zone {
            border: 2px dashed var(--border);
            border-radius: var(--radius-sm);
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 16px;
        }

        .upload-zone:hover, .upload-zone.dragover {
            border-color: var(--accent);
            background: rgba(99, 102, 241, 0.05);
        }

        .upload-zone svg {
            width: 40px;
            height: 40px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .upload-zone p {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .upload-zone span {
            color: var(--accent);
            font-weight: 500;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            width: 100%;
            max-width: 480px;
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }

        .modal-overlay.active .modal {
            transform: scale(1);
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-family: 'DM Serif Display', serif;
            font-size: 22px;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .modal-body {
            padding: 24px;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .export-progress {
            margin-top: 20px;
        }

        .progress-bar {
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), #a855f7);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 13px;
            color: var(--text-secondary);
            text-align: center;
        }

        .toast-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 1001;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .toast {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 14px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.3s ease;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast-success { border-left: 3px solid var(--success); }
        .toast-error { border-left: 3px solid var(--danger); }
        .toast-info { border-left: 3px solid var(--accent); }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            color: var(--text-muted);
            margin-bottom: 16px;
        }

        .empty-state h3 {
            font-size: 18px;
            margin-bottom: 8px;
        }

        .empty-state p {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .text-style-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .text-style-option {
            padding: 12px;
            background: var(--bg-tertiary);
            border: 2px solid transparent;
            border-radius: var(--radius-sm);
            cursor: pointer;
            text-align: center;
            transition: all 0.2s ease;
        }

        .text-style-option:hover {
            border-color: var(--border);
        }

        .text-style-option.active {
            border-color: var(--accent);
            background: rgba(99, 102, 241, 0.1);
        }

        .text-style-option .label {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .transition-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .transition-option {
            padding: 10px;
            background: var(--bg-tertiary);
            border: 2px solid transparent;
            border-radius: var(--radius-sm);
            cursor: pointer;
            text-align: center;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .transition-option:hover {
            border-color: var(--border);
        }

        .transition-option.active {
            border-color: var(--accent);
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 280px 1fr;
            }
            .settings-panel {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                height: auto;
            }
            .slides-panel {
                order: 2;
            }
            .preview-panel {
                order: 1;
            }
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--bg-hover);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        .clear-image-btn {
            width: 100%;
            padding: 8px;
            margin-top: 8px;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: var(--radius-sm);
            color: var(--danger);
            font-family: inherit;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .clear-image-btn:hover {
            background: rgba(239, 68, 68, 0.2);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="header">
            <div class="logo">
                <div class="logo-icon">▶</div>
                <div class="logo-text">Slide<span>Forge</span></div>
            </div>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="clearProject()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                    </svg>
                    Clear All
                </button>
                <button class="btn btn-primary" onclick="openExportModal()" id="exportBtn" disabled>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/>
                    </svg>
                    Export Video
                </button>
            </div>
        </header>

        <div class="main-content">
            <!-- Slides Panel -->
            <div class="panel slides-panel">
                <div class="panel-header">
                    <span class="panel-title">Slides</span>
                    <span id="slideCount" style="font-size: 12px; color: var(--text-muted);">0 slides</span>
                </div>
                <div class="panel-body">
                    <div id="slidesList" class="slides-list"></div>
                    <button class="add-slide-btn" onclick="addSlide()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 5v14M5 12h14"/>
                        </svg>
                        <span>Add Slide</span>
                    </button>
                </div>
            </div>

            <!-- Preview Panel -->
            <div class="panel preview-panel">
                <div class="preview-stage">
                    <div class="preview-canvas-wrapper">
                        <canvas id="previewCanvas" width="1280" height="720"></canvas>
                    </div>
                </div>
                <div class="preview-controls">
                    <button class="play-btn" onclick="togglePlayback()" id="playBtn" disabled>
                        <svg viewBox="0 0 24 24" fill="currentColor" id="playIcon">
                            <path d="M8 5v14l11-7z"/>
                        </svg>
                    </button>
                    <div class="timeline" onclick="seekTimeline(event)">
                        <div class="timeline-progress" id="timelineProgress"></div>
                    </div>
                    <div class="time-display">
                        <span id="currentTime">0:00</span> / <span id="totalTime">0:00</span>
                    </div>
                </div>
            </div>

            <!-- Settings Panel -->
            <div class="panel settings-panel">
                <div class="panel-header">
                    <span class="panel-title">Slide Settings</span>
                </div>
                <div class="panel-body" id="settingsPanel">
                    <div class="empty-state" id="noSlideSelected">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <rect x="3" y="3" width="18" height="18" rx="2"/>
                            <path d="M3 9h18M9 21V9"/>
                        </svg>
                        <h3>No Slide Selected</h3>
                        <p>Select or add a slide to edit its properties</p>
                    </div>

                    <div id="slideSettings" class="hidden">
                        <div class="settings-group">
                            <div class="settings-group-title">Background</div>
                            <div class="upload-zone" id="uploadZone">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <rect x="3" y="3" width="18" height="18" rx="2"/>
                                    <circle cx="8.5" cy="8.5" r="1.5"/>
                                    <path d="M21 15l-5-5L5 21"/>
                                </svg>
                                <p>Drop image or <span>browse</span></p>
                            </div>
                            <input type="file" id="imageInput" accept="image/*" style="display:none">
                            <button class="clear-image-btn hidden" id="clearImageBtn" onclick="clearCurrentImage()">Remove Image</button>

                            <div class="form-group">
                                <label class="form-label">Or Background Color</label>
                                <div class="color-picker-wrapper">
                                    <input type="color" class="color-picker" id="bgColor" value="#1a1a2e">
                                    <div class="color-presets">
                                        <div class="color-preset" style="background: #1a1a2e" onclick="setBgColor('#1a1a2e')"></div>
                                        <div class="color-preset" style="background: #16213e" onclick="setBgColor('#16213e')"></div>
                                        <div class="color-preset" style="background: #0f3460" onclick="setBgColor('#0f3460')"></div>
                                        <div class="color-preset" style="background: #533483" onclick="setBgColor('#533483')"></div>
                                        <div class="color-preset" style="background: #e94560" onclick="setBgColor('#e94560')"></div>
                                        <div class="color-preset" style="background: #ffffff" onclick="setBgColor('#ffffff')"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="settings-group">
                            <div class="settings-group-title">Text Content</div>
                            <div class="form-group">
                                <label class="form-label">Heading</label>
                                <input type="text" class="form-input" id="slideHeading" placeholder="Enter heading...">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Subtext</label>
                                <textarea class="form-input" id="slideSubtext" placeholder="Enter description..."></textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Text Color</label>
                                <div class="color-picker-wrapper">
                                    <input type="color" class="color-picker" id="textColor" value="#ffffff">
                                    <div class="color-presets">
                                        <div class="color-preset" style="background: #ffffff" onclick="setTextColor('#ffffff')"></div>
                                        <div class="color-preset" style="background: #f4f4f5" onclick="setTextColor('#f4f4f5')"></div>
                                        <div class="color-preset" style="background: #1a1a1a" onclick="setTextColor('#1a1a1a')"></div>
                                        <div class="color-preset" style="background: #6366f1" onclick="setTextColor('#6366f1')"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="settings-group">
                            <div class="settings-group-title">Text Position</div>
                            <div class="text-style-options">
                                <div class="text-style-option active" data-position="center" onclick="setTextPosition('center')">
                                    <div style="font-size: 18px;">⬛</div>
                                    <div class="label">Center</div>
                                </div>
                                <div class="text-style-option" data-position="bottom" onclick="setTextPosition('bottom')">
                                    <div style="font-size: 18px;">⬇</div>
                                    <div class="label">Bottom</div>
                                </div>
                                <div class="text-style-option" data-position="top" onclick="setTextPosition('top')">
                                    <div style="font-size: 18px;">⬆</div>
                                    <div class="label">Top</div>
                                </div>
                                <div class="text-style-option" data-position="left" onclick="setTextPosition('left')">
                                    <div style="font-size: 18px;">⬅</div>
                                    <div class="label">Left</div>
                                </div>
                            </div>
                        </div>

                        <div class="settings-group">
                            <div class="settings-group-title">Timing</div>
                            <div class="form-group">
                                <label class="form-label">Duration (seconds)</label>
                                <input type="range" class="range-input" id="slideDuration" min="1" max="15" value="5">
                                <div class="range-value" id="durationValue">5s</div>
                            </div>
                        </div>

                        <div class="settings-group">
                            <div class="settings-group-title">Transition</div>
                            <div class="transition-grid">
                                <div class="transition-option active" data-transition="fade" onclick="setTransition('fade')">Fade</div>
                                <div class="transition-option" data-transition="slide" onclick="setTransition('slide')">Slide</div>
                                <div class="transition-option" data-transition="zoom" onclick="setTransition('zoom')">Zoom</div>
                                <div class="transition-option" data-transition="none" onclick="setTransition('none')">None</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="modal-overlay" id="exportModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Export Video</h2>
                <button class="modal-close" onclick="closeExportModal()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Video Quality</label>
                    <select class="form-select" id="videoQuality">
                        <option value="720">HD (1280×720)</option>
                        <option value="1080" selected>Full HD (1920×1080)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Frame Rate</label>
                    <select class="form-select" id="frameRate">
                        <option value="24">24 FPS (Cinematic)</option>
                        <option value="30" selected>30 FPS (Standard)</option>
                        <option value="60">60 FPS (Smooth)</option>
                    </select>
                </div>
                <div class="export-progress hidden" id="exportProgress">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                    </div>
                    <p class="progress-text" id="progressText">Preparing...</p>
                </div>
            </div>
            <div class="modal-footer" id="exportFooter">
                <button class="btn btn-secondary" onclick="closeExportModal()">Cancel</button>
                <button class="btn btn-primary" onclick="startExport()" id="startExportBtn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/>
                    </svg>
                    Start Export
                </button>
            </div>
        </div>
    </div>

    <div class="toast-container" id="toastContainer"></div>

    <script>
        // =====================
        // State Management
        // =====================
        let slides = [];
        let currentSlideIndex = -1;
        let isPlaying = false;
        let animationFrame = null;
        let playbackStartTime = 0;

        // Image cache for better performance
        const imageCache = new Map();

        const canvas = document.getElementById('previewCanvas');
        const ctx = canvas.getContext('2d');

        // =====================
        // DOM References & Event Listeners
        // =====================
        const uploadZone = document.getElementById('uploadZone');
        const imageInput = document.getElementById('imageInput');
        const bgColorInput = document.getElementById('bgColor');
        const textColorInput = document.getElementById('textColor');
        const slideHeadingInput = document.getElementById('slideHeading');
        const slideSubtextInput = document.getElementById('slideSubtext');
        const slideDurationInput = document.getElementById('slideDuration');
        const clearImageBtn = document.getElementById('clearImageBtn');

        // Setup event listeners
        uploadZone.addEventListener('click', () => {
            if (currentSlideIndex >= 0) {
                imageInput.click();
            } else {
                showToast('Add a slide first', 'error');
            }
        });

        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            if (currentSlideIndex >= 0) {
                uploadZone.classList.add('dragover');
            }
        });

        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });

        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            if (currentSlideIndex < 0) {
                showToast('Add a slide first', 'error');
                return;
            }
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                processImage(file);
            }
        });

        imageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                processImage(file);
            }
            // Reset input so same file can be selected again
            e.target.value = '';
        });

        bgColorInput.addEventListener('change', (e) => {
            updateSlideProperty('bgColor', e.target.value);
        });

        textColorInput.addEventListener('change', (e) => {
            updateSlideProperty('textColor', e.target.value);
        });

        slideHeadingInput.addEventListener('input', (e) => {
            updateSlideProperty('heading', e.target.value);
        });

        slideSubtextInput.addEventListener('input', (e) => {
            updateSlideProperty('subtext', e.target.value);
        });

        slideDurationInput.addEventListener('input', (e) => {
            const value = parseFloat(e.target.value);
            document.getElementById('durationValue').textContent = value + 's';
            updateSlideProperty('duration', value);
        });

        // =====================
        // Slide Management
        // =====================
        function createSlide() {
            return {
                id: Date.now(),
                image: null,
                imageObj: null, // Cached Image object
                bgColor: '#1a1a2e',
                heading: '',
                subtext: '',
                textColor: '#ffffff',
                textPosition: 'center',
                duration: 5,
                transition: 'fade'
            };
        }

        function addSlide() {
            const slide = createSlide();
            slides.push(slide);
            currentSlideIndex = slides.length - 1;
            renderSlidesList();
            renderPreview();
            showSlideSettings();
            updateControls();
            showToast('Slide added', 'success');
        }

        function selectSlide(index) {
            if (index < 0 || index >= slides.length) return;
            currentSlideIndex = index;
            renderSlidesList();
            renderPreview();
            showSlideSettings();
        }

        function deleteSlide(index, event) {
            event.stopPropagation();

            // Clear image cache for this slide
            const slide = slides[index];
            if (slide.image) {
                imageCache.delete(slide.image);
            }

            slides.splice(index, 1);

            if (slides.length === 0) {
                currentSlideIndex = -1;
                hideSlideSettings();
            } else if (currentSlideIndex >= slides.length) {
                currentSlideIndex = slides.length - 1;
            } else if (currentSlideIndex === index) {
                // Stay on same index but refresh settings
                currentSlideIndex = Math.min(index, slides.length - 1);
            }

            renderSlidesList();
            renderPreview();
            updateControls();

            if (slides.length > 0 && currentSlideIndex >= 0) {
                showSlideSettings();
            }

            showToast('Slide deleted', 'info');
        }

        function renderSlidesList() {
            const container = document.getElementById('slidesList');
            container.innerHTML = slides.map((slide, index) => `
                <div class="slide-card ${index === currentSlideIndex ? 'active' : ''}" onclick="selectSlide(${index})">
                    <button class="slide-card-delete" onclick="deleteSlide(${index}, event)">×</button>
                    <div class="slide-card-preview" style="background-color: ${slide.bgColor}">
                        ${slide.image ? `<img src="${slide.image}" alt="Slide ${index + 1}">` :
                          slide.heading ? `<span style="color: ${slide.textColor}; font-size: 10px; padding: 8px; text-align: center; word-break: break-word;">${slide.heading.substring(0, 30)}${slide.heading.length > 30 ? '...' : ''}</span>` :
                          '<span class="placeholder">Empty slide</span>'}
                    </div>
                    <div class="slide-card-info">
                        <span class="slide-card-number">Slide ${index + 1}</span>
                        <span class="slide-card-duration">${slide.duration}s</span>
                    </div>
                </div>
            `).join('');

            document.getElementById('slideCount').textContent = `${slides.length} slide${slides.length !== 1 ? 's' : ''}`;
        }

        // =====================
        // Settings Panel
        // =====================
        function showSlideSettings() {
            if (currentSlideIndex < 0 || !slides[currentSlideIndex]) {
                hideSlideSettings();
                return;
            }
            document.getElementById('noSlideSelected').classList.add('hidden');
            document.getElementById('slideSettings').classList.remove('hidden');
            populateSettings();
        }

        function hideSlideSettings() {
            document.getElementById('noSlideSelected').classList.remove('hidden');
            document.getElementById('slideSettings').classList.add('hidden');
        }

        function populateSettings() {
            if (currentSlideIndex < 0 || !slides[currentSlideIndex]) return;

            const slide = slides[currentSlideIndex];
            bgColorInput.value = slide.bgColor;
            slideHeadingInput.value = slide.heading;
            slideSubtextInput.value = slide.subtext;
            textColorInput.value = slide.textColor;
            slideDurationInput.value = slide.duration;
            document.getElementById('durationValue').textContent = slide.duration + 's';

            // Show/hide clear image button
            clearImageBtn.classList.toggle('hidden', !slide.image);

            // Update position buttons
            document.querySelectorAll('.text-style-option').forEach(el => {
                el.classList.toggle('active', el.dataset.position === slide.textPosition);
            });

            // Update transition buttons
            document.querySelectorAll('.transition-option').forEach(el => {
                el.classList.toggle('active', el.dataset.transition === slide.transition);
            });
        }

        function updateSlideProperty(prop, value) {
            if (currentSlideIndex < 0 || !slides[currentSlideIndex]) return;
            slides[currentSlideIndex][prop] = value;
            renderSlidesList();
            renderPreview();
            updateTotalTime();
        }

        function setBgColor(color) {
            bgColorInput.value = color;
            updateSlideProperty('bgColor', color);
        }

        function setTextColor(color) {
            textColorInput.value = color;
            updateSlideProperty('textColor', color);
        }

        function setTextPosition(position) {
            document.querySelectorAll('.text-style-option').forEach(el => {
                el.classList.toggle('active', el.dataset.position === position);
            });
            updateSlideProperty('textPosition', position);
        }

        function setTransition(transition) {
            document.querySelectorAll('.transition-option').forEach(el => {
                el.classList.toggle('active', el.dataset.transition === transition);
            });
            updateSlideProperty('transition', transition);
        }

        function clearCurrentImage() {
            if (currentSlideIndex < 0 || !slides[currentSlideIndex]) return;
            const slide = slides[currentSlideIndex];
            if (slide.image) {
                imageCache.delete(slide.image);
            }
            slide.image = null;
            slide.imageObj = null;
            clearImageBtn.classList.add('hidden');
            renderSlidesList();
            renderPreview();
            showToast('Image removed', 'info');
        }

        // =====================
        // Image Handling
        // =====================
        function processImage(file) {
            if (currentSlideIndex < 0) {
                showToast('Add a slide first', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                const dataUrl = e.target.result;

                // Preload and cache image
                const img = new Image();
                img.onload = () => {
                    slides[currentSlideIndex].image = dataUrl;
                    slides[currentSlideIndex].imageObj = img;
                    imageCache.set(dataUrl, img);
                    clearImageBtn.classList.remove('hidden');
                    renderSlidesList();
                    renderPreview();
                    showToast('Image added', 'success');
                };
                img.onerror = () => {
                    showToast('Failed to load image', 'error');
                };
                img.src = dataUrl;
            };
            reader.onerror = () => {
                showToast('Failed to read file', 'error');
            };
            reader.readAsDataURL(file);
        }

        function getImageFromCache(src) {
            if (imageCache.has(src)) {
                return imageCache.get(src);
            }

            // Create and cache new image
            const img = new Image();
            img.src = src;
            imageCache.set(src, img);
            return img;
        }

        // =====================
        // Canvas Rendering
        // =====================
        function renderPreview(slideIndex = currentSlideIndex, alpha = 1) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (slideIndex < 0 || !slides[slideIndex]) {
                // Empty state
                ctx.fillStyle = '#1a1a2e';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#71717a';
                ctx.font = '24px Instrument Sans, sans-serif';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('Add slides to preview', canvas.width / 2, canvas.height / 2);
                return;
            }

            const slide = slides[slideIndex];

            // Background
            ctx.fillStyle = slide.bgColor;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Image (using cache)
            if (slide.image) {
                const img = slide.imageObj || getImageFromCache(slide.image);
                if (img.complete && img.naturalWidth > 0) {
                    ctx.save();
                    ctx.globalAlpha = alpha;
                    const scale = Math.max(canvas.width / img.width, canvas.height / img.height);
                    const x = (canvas.width - img.width * scale) / 2;
                    const y = (canvas.height - img.height * scale) / 2;
                    ctx.drawImage(img, x, y, img.width * scale, img.height * scale);
                    ctx.restore();
                }
            }

            drawText(slide, alpha);
        }

        function drawText(slide, alpha = 1) {
            if (!slide.heading && !slide.subtext) return;

            ctx.save();
            ctx.globalAlpha = alpha;

            // Text shadow for readability
            ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
            ctx.shadowBlur = 10;
            ctx.shadowOffsetX = 2;
            ctx.shadowOffsetY = 2;

            let textY, textAlign = 'center';
            let textX = canvas.width / 2;

            switch (slide.textPosition) {
                case 'top':
                    textY = 120;
                    break;
                case 'bottom':
                    textY = canvas.height - 150;
                    break;
                case 'left':
                    textX = 80;
                    textY = canvas.height / 2;
                    textAlign = 'left';
                    break;
                default: // center
                    textY = canvas.height / 2 - 20;
            }

            ctx.textAlign = textAlign;
            ctx.textBaseline = 'middle';
            ctx.fillStyle = slide.textColor;

            // Heading
            if (slide.heading) {
                ctx.font = 'bold 56px DM Serif Display, serif';
                wrapText(ctx, slide.heading, textX, textY, canvas.width - 160, 65);
            }

            // Subtext
            if (slide.subtext) {
                ctx.font = '28px Instrument Sans, sans-serif';
                const subtextY = slide.heading ? textY + 80 : textY;
                wrapText(ctx, slide.subtext, textX, subtextY, canvas.width - 160, 38);
            }

            ctx.restore();
        }

        function wrapText(ctx, text, x, y, maxWidth, lineHeight) {
            const words = text.split(' ');
            let line = '';
            let currentY = y;

            for (let i = 0; i < words.length; i++) {
                const testLine = line + words[i] + ' ';
                const metrics = ctx.measureText(testLine);
                if (metrics.width > maxWidth && line !== '') {
                    ctx.fillText(line.trim(), x, currentY);
                    line = words[i] + ' ';
                    currentY += lineHeight;
                } else {
                    line = testLine;
                }
            }
            ctx.fillText(line.trim(), x, currentY);
        }

        // =====================
        // Playback
        // =====================
        function togglePlayback() {
            if (slides.length === 0) {
                showToast('Add slides first', 'error');
                return;
            }

            isPlaying = !isPlaying;

            const playIcon = document.getElementById('playIcon');
            if (isPlaying) {
                playIcon.innerHTML = '<rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/>';
                startPlayback();
            } else {
                playIcon.innerHTML = '<path d="M8 5v14l11-7z"/>';
                stopPlayback();
            }
        }

        function startPlayback() {
            playbackStartTime = performance.now();
            let currentPlaybackSlide = 0;

            function animate(timestamp) {
                if (!isPlaying) return;

                const totalElapsed = (timestamp - playbackStartTime) / 1000;
                const totalDuration = getTotalDuration();

                // Loop back to start
                const loopedTime = totalElapsed % totalDuration;

                // Find current slide based on time
                let accumulated = 0;
                let slideIndex = 0;
                let slideStartTime = 0;

                for (let i = 0; i < slides.length; i++) {
                    if (accumulated + slides[i].duration > loopedTime) {
                        slideIndex = i;
                        slideStartTime = accumulated;
                        break;
                    }
                    accumulated += slides[i].duration;
                }

                const slideTime = loopedTime - slideStartTime;
                const slide = slides[slideIndex];

                // Calculate fade in alpha
                let alpha = 1;
                if (slide.transition === 'fade' && slideTime < 0.5) {
                    alpha = slideTime / 0.5;
                }

                renderPreview(slideIndex, alpha);
                updateTimeDisplay(loopedTime);

                animationFrame = requestAnimationFrame(animate);
            }

            animationFrame = requestAnimationFrame(animate);
        }

        function stopPlayback() {
            if (animationFrame) {
                cancelAnimationFrame(animationFrame);
                animationFrame = null;
            }
            renderPreview();
        }

        function updateTimeDisplay(elapsed) {
            const total = getTotalDuration();
            document.getElementById('currentTime').textContent = formatTime(elapsed);
            document.getElementById('timelineProgress').style.width = `${(elapsed / total) * 100}%`;
        }

        function getTotalDuration() {
            return slides.reduce((sum, slide) => sum + slide.duration, 0);
        }

        function updateTotalTime() {
            document.getElementById('totalTime').textContent = formatTime(getTotalDuration());
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function seekTimeline(event) {
            if (slides.length === 0) return;

            const rect = event.target.getBoundingClientRect();
            const progress = Math.max(0, Math.min(1, (event.clientX - rect.left) / rect.width));
            const targetTime = progress * getTotalDuration();

            // Find which slide this corresponds to
            let accumulated = 0;
            for (let i = 0; i < slides.length; i++) {
                if (accumulated + slides[i].duration > targetTime) {
                    selectSlide(i);
                    break;
                }
                accumulated += slides[i].duration;
            }
        }

        function updateControls() {
            const hasSlides = slides.length > 0;
            document.getElementById('exportBtn').disabled = !hasSlides;
            document.getElementById('playBtn').disabled = !hasSlides;
            updateTotalTime();
        }

        // =====================
        // Export
        // =====================
        function openExportModal() {
            if (slides.length === 0) {
                showToast('Add slides first', 'error');
                return;
            }
            document.getElementById('exportModal').classList.add('active');
        }

        function closeExportModal() {
            document.getElementById('exportModal').classList.remove('active');
            document.getElementById('exportProgress').classList.add('hidden');
            document.getElementById('exportFooter').classList.remove('hidden');
            document.getElementById('startExportBtn').disabled = false;
        }

        async function startExport() {
            const quality = parseInt(document.getElementById('videoQuality').value);
            const fps = parseInt(document.getElementById('frameRate').value);

            document.getElementById('exportProgress').classList.remove('hidden');
            document.getElementById('exportFooter').classList.add('hidden');
            document.getElementById('startExportBtn').disabled = true;

            // Create offscreen canvas with correct aspect ratio
            const width = quality === 1080 ? 1920 : 1280;
            const height = quality === 1080 ? 1080 : 720;
            const exportCanvas = document.createElement('canvas');
            exportCanvas.width = width;
            exportCanvas.height = height;
            const exportCtx = exportCanvas.getContext('2d');

            // Preload all images first
            document.getElementById('progressText').textContent = 'Loading images...';
            await preloadAllImages();

            try {
                // Check for MediaRecorder support
                let mimeType = 'video/webm;codecs=vp9';
                if (!MediaRecorder.isTypeSupported(mimeType)) {
                    mimeType = 'video/webm;codecs=vp8';
                    if (!MediaRecorder.isTypeSupported(mimeType)) {
                        mimeType = 'video/webm';
                        if (!MediaRecorder.isTypeSupported(mimeType)) {
                            throw new Error('WebM video format not supported in this browser');
                        }
                    }
                }

                const stream = exportCanvas.captureStream(fps);
                const mediaRecorder = new MediaRecorder(stream, {
                    mimeType: mimeType,
                    videoBitsPerSecond: quality === 1080 ? 8000000 : 5000000
                });

                const chunks = [];
                mediaRecorder.ondataavailable = (e) => {
                    if (e.data.size > 0) {
                        chunks.push(e.data);
                    }
                };

                return new Promise((resolve, reject) => {
                    mediaRecorder.onstop = () => {
                        try {
                            const blob = new Blob(chunks, { type: 'video/webm' });
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `slideforge-video-${Date.now()}.webm`;
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            URL.revokeObjectURL(url);

                            closeExportModal();
                            showToast('Video exported successfully!', 'success');
                            resolve();
                        } catch (err) {
                            reject(err);
                        }
                    };

                    mediaRecorder.onerror = (e) => {
                        reject(new Error('MediaRecorder error'));
                    };

                    mediaRecorder.start(100); // Collect data every 100ms

                    const totalDuration = getTotalDuration();
                    const totalFrames = Math.ceil(totalDuration * fps);
                    let currentFrame = 0;

                    const frameInterval = 1000 / fps;
                    let lastFrameTime = performance.now();

                    function renderNextFrame() {
                        if (currentFrame >= totalFrames) {
                            // Add small delay before stopping to ensure all frames are captured
                            setTimeout(() => {
                                mediaRecorder.stop();
                            }, 200);
                            return;
                        }

                        const currentTime = currentFrame / fps;

                        // Find current slide
                        let accumulated = 0;
                        let slideIndex = 0;
                        let slideStartTime = 0;

                        for (let i = 0; i < slides.length; i++) {
                            if (accumulated + slides[i].duration > currentTime) {
                                slideIndex = i;
                                slideStartTime = accumulated;
                                break;
                            }
                            accumulated += slides[i].duration;
                        }

                        const slide = slides[slideIndex];
                        const slideTime = currentTime - slideStartTime;

                        // Render to export canvas
                        renderSlideToExportCanvas(exportCtx, slide, width, height, slideTime);

                        // Update progress
                        const progress = ((currentFrame + 1) / totalFrames) * 100;
                        document.getElementById('progressFill').style.width = `${progress}%`;
                        document.getElementById('progressText').textContent =
                            `Rendering: ${Math.round(progress)}% (${currentFrame + 1}/${totalFrames} frames)`;

                        currentFrame++;

                        // Use setTimeout for more consistent timing
                        setTimeout(renderNextFrame, frameInterval / 2);
                    }

                    renderNextFrame();
                });

            } catch (error) {
                closeExportModal();
                showToast(`Export failed: ${error.message}`, 'error');
                console.error('Export error:', error);
            }
        }

        async function preloadAllImages() {
            const promises = slides.map(slide => {
                if (slide.image && !slide.imageObj) {
                    return new Promise((resolve) => {
                        const img = new Image();
                        img.onload = () => {
                            slide.imageObj = img;
                            imageCache.set(slide.image, img);
                            resolve();
                        };
                        img.onerror = resolve; // Continue even if image fails
                        img.src = slide.image;
                    });
                }
                return Promise.resolve();
            });

            await Promise.all(promises);
        }

        function renderSlideToExportCanvas(ctx, slide, width, height, time) {
            // Clear and draw background
            ctx.fillStyle = slide.bgColor;
            ctx.fillRect(0, 0, width, height);

            // Calculate fade alpha
            let alpha = 1;
            if (slide.transition === 'fade' && time < 0.5) {
                alpha = Math.min(1, time / 0.5);
            }

            // Draw image
            if (slide.image) {
                const img = slide.imageObj || imageCache.get(slide.image);
                if (img && img.complete && img.naturalWidth > 0) {
                    ctx.save();
                    ctx.globalAlpha = alpha;
                    const scale = Math.max(width / img.width, height / img.height);
                    const x = (width - img.width * scale) / 2;
                    const y = (height - img.height * scale) / 2;
                    ctx.drawImage(img, x, y, img.width * scale, img.height * scale);
                    ctx.restore();
                }
            }

            // Draw text
            if (slide.heading || slide.subtext) {
                ctx.save();
                ctx.globalAlpha = alpha;
                ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
                ctx.shadowBlur = 10 * (width / 1280);
                ctx.shadowOffsetX = 2 * (width / 1280);
                ctx.shadowOffsetY = 2 * (width / 1280);

                const scaleFactor = width / 1280;
                let textY, textAlign = 'center';
                let textX = width / 2;

                switch (slide.textPosition) {
                    case 'top':
                        textY = 120 * scaleFactor;
                        break;
                    case 'bottom':
                        textY = height - 150 * scaleFactor;
                        break;
                    case 'left':
                        textX = 80 * scaleFactor;
                        textY = height / 2;
                        textAlign = 'left';
                        break;
                    default:
                        textY = height / 2 - 20 * scaleFactor;
                }

                ctx.textAlign = textAlign;
                ctx.textBaseline = 'middle';
                ctx.fillStyle = slide.textColor;

                if (slide.heading) {
                    ctx.font = `bold ${Math.round(56 * scaleFactor)}px DM Serif Display, serif`;
                    wrapTextExport(ctx, slide.heading, textX, textY, width - 160 * scaleFactor, 65 * scaleFactor);
                }

                if (slide.subtext) {
                    ctx.font = `${Math.round(28 * scaleFactor)}px Instrument Sans, sans-serif`;
                    const subtextY = slide.heading ? textY + 80 * scaleFactor : textY;
                    wrapTextExport(ctx, slide.subtext, textX, subtextY, width - 160 * scaleFactor, 38 * scaleFactor);
                }

                ctx.restore();
            }
        }

        function wrapTextExport(ctx, text, x, y, maxWidth, lineHeight) {
            const words = text.split(' ');
            let line = '';
            let currentY = y;

            for (let i = 0; i < words.length; i++) {
                const testLine = line + words[i] + ' ';
                const metrics = ctx.measureText(testLine);
                if (metrics.width > maxWidth && line !== '') {
                    ctx.fillText(line.trim(), x, currentY);
                    line = words[i] + ' ';
                    currentY += lineHeight;
                } else {
                    line = testLine;
                }
            }
            ctx.fillText(line.trim(), x, currentY);
        }

        // =====================
        // Utilities
        // =====================
        function clearProject() {
            if (slides.length === 0) return;
            if (confirm('Clear all slides? This cannot be undone.')) {
                // Stop playback if playing
                if (isPlaying) {
                    togglePlayback();
                }

                // Clear image cache
                imageCache.clear();

                slides = [];
                currentSlideIndex = -1;
                renderSlidesList();
                renderPreview();
                hideSlideSettings();
                updateControls();
                showToast('Project cleared', 'info');
            }
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    ${type === 'success' ? '<path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><path d="M22 4L12 14.01l-3-3"/>' :
                      type === 'error' ? '<circle cx="12" cy="12" r="10"/><path d="M15 9l-6 6M9 9l6 6"/>' :
                      '<circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/>'}
                </svg>
                <span>${message}</span>
            `;
            container.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                toast.style.transition = 'all 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // =====================
        // Initialize
        // =====================
        renderPreview();
        updateTotalTime();
        updateControls();
    </script>
</body>
</html>
